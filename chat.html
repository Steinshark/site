<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="shortcut icon" type="image/x-icon" href="images/favicon.png">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-49NV8NMBJP"></script>
  <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-49NV8NMBJP');
  </script>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="chat.css" />
  <script src="https://cdn.jsdelivr.net/npm/@microsoft/fetch-event-source@2.0.1/lib/umd/index.min.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SLM Chat Interface</title>
  <style>

    /* Assume your header height is 75px */
    .main {
      display: flex;
      height: calc(100vh - 75px); /* full viewport minus header */
      overflow: hidden;
    }

    .sidebar {
      width: 20%;
      background-color: var(--panel-dark);
      padding: 1rem;
      overflow-y: auto;
      border-right: 1px solid #333;
      height: 100%; /* now constrained by .main */
      box-sizing: border-box;
    }





   .buttonsend {
      margin-left: 0.5rem;
      background: #3f3f3f;
      border: none;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-weight: bold;
      color: #3f3f3f;
      background: blue;
   }


    .sidebar button {
      margin-bottom: 1rem;
      background: var(--accent);
      border: none;
      padding: 0.5rem 1rem;
      width: 100%;
      font-weight: bold;
      color: black;
      cursor: pointer;
    }

    .conversation-item {
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 4px;
    }

    .conversation-item:hover {
      background-color: #333;
    }

    .form-container {
      max-width: 400px;
      margin: 2rem auto;
      background-color: #1e1e1e;
      padding: 2rem;
      border-radius: 8px;
    }

    .form-container h2 {
      text-align: center;
    }

    .form-container input[type="text"],
    .form-container input[type="password"] {
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0;
      background-color: #2a2a2a;
      color: var(--text-light);
      border: none;
      border-radius: 4px;
    }

    .form-container button {
      width: 100%;
      padding: 0.75rem;
      margin-top: 1rem;
      background: var(--accent);
      color: black;
      font-weight: bold;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .stat {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 14px;
    }

  .stat .label {
    flex: 1;
    font-weight: bold;
    color: #ccc;
  }

  .stat .value {
    text-align: right;
    white-space: nowrap;
    margin-left: 10px;
    color: #eee;
  }

  .message {
  margin: 10px 0;        /* spacing between messages */
  display: flex;
  }

  .message.user {
    justify-content: flex-end;  /* push user messages to the right */
  }

  .message.bot {
    justify-content: flex-start; /* bot messages stay on the left */
  }

  .message-text {
    max-width: 70%;
    padding: 8px 12px;
    border-radius: 12px;
    line-height: 1.4;
    word-break: break-word;   /* breaks within long words if needed */
    overflow-wrap: break-word; /* fallback for older browsers */
  }

  .message.user .message-text {
    background-color: #0078ff;  /* blue bubble */
    color: white;
  }

  .message.bot .message-text {
    background-color: #333;     /* dark bubble */
    color: #eee;
  }


  #debug-container {
    margin-top: 10px;
  }

  #debug-box {
    width: 100%;
    height: 120px;
    background-color: #1e1e1e;
    color: #00ff88;
    border: 1px solid #444;
    border-radius: 4px;
    padding: 8px;
    font-family: monospace;
    font-size: 0.9em;
    resize: none;
    overflow-y: scroll;
    box-sizing: border-box;
  }
  /* Mobile: hide sidebar and let chat take full width */
  @media (max-width: 768px) {
    .sidebar {
      display: none;
    }

    .chat-container {
      width: 100%;
    }
  }

  </style>
</head>
<body>
  <header>
    <div><strong>SLM Chat</strong></div>
    <nav>
      <a href="./index.html">Home</a>
      <a href="./story.html">Story</a>
      <a href="./projects.html">Projects</a>
      <a href="./chat.html">Chat</a>
      <a href="./project-chat-data.html">Test Model</a>
    </nav>
    <div class="code-stream"></div>
  </header>

  <div class="main" id="chat-section">
    <aside class="sidebar">
      <h2>Model Stats</h2>
      <div class="stat">
        <span class="label">Name:</span>
        <span class="value" id="model_name">Steinshark LLM</span>
      </div>
      <div class="stat">
        <span class="label">Parameters:</span>
        <span class="value" id="param_count">loading...</span>
      </div>
      <div class="stat">
        <span class="label">Layers:</span>
        <span class="value" id="layer_count">loading...</span>
      </div>
      <div class="stat">
        <span class="label">Embedding Size:</span>
        <span class="value" id="embed_size">loading...</span>
      </div>
      <div class="stat">
        <span class="label">Vocab Size:</span>
        <span class="value" id="vocab_size">loading...</span>
      </div>

      <hr style="border: 0; border-top: 1px solid #444; margin: 15px 0;">

      <div class="stat">
        <span class="label">Training Phase:</span>
        <span class="value" id="phase">loading...</span>
      </div>
      <div class="stat">
        <span class="label">Current Loss:</span>
        <span class="value" id="loss">loading...</span>
      </div>
      <div class="stat">
        <span class="label">Data Type:</span>
        <span class="value" id="dtype">loading...</span>
      </div>
      <div class="stat">
        <span class="label">Tokens Trained:</span>
        <span class="value" id="tokens_trained">loading...</span>
      </div>
      <div class="stat">
        <span class="label">Last Update:</span>
        <span class="value" id="last_update">loading...</span>
      </div>      

      <hr style="border: 0; border-top: 1px solid #444; margin: 15px 0;">
      <div id="debug-container">
        <label for="debug-box" style="color: #ccc; font-weight: bold;">Debug Log</label><br>
        <textarea id="debug-box" readonly></textarea>
      </div>
    </aside>

      <div class="chatbox">
        <div class="messages" id="messages"></div>
        <div class="input">
          <textarea id="user-input" rows="2" placeholder="Type your message..."></textarea>
          <button class="buttonsend" id="sendBtn">Send</button>
        </div>
      </div>
    </div>
    
    <div id="create-account-section" class="form-container" style="display:none">
      <h2>Create Account</h2>
      <input type="text" id="username" placeholder="Username">
      <input type="password" id="password" placeholder="Password">
      <button onclick="createAccount()">Create Account</button>
    </div>


    
    
    <script>
      function appendToDebugLog(text) {
        const box = document.getElementById('debug-box');
        const timestamp = new Date().toLocaleTimeString();
        box.value += `[${timestamp}] ${text}\n`;
        box.scrollTop = box.scrollHeight;  // Auto-scroll
      }
      
      // Example usage
      appendToDebugLog("Debug log initialized.");
      
      function getStats() {
        appendToDebugLog("building payload");
        const payload = {
          request_type: "stats",
          request_ip: "127.0.0.1"
        };
        fetch("https://api.hipowerpc.com/api/stats", {
          
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
          document.getElementById("param_count").innerText = data.param_count;
          document.getElementById("layer_count").innerText = data.layer_count;
          document.getElementById("embed_size").innerText = data.embed_size;
          document.getElementById("vocab_size").innerText = data.vocab_size;
          document.getElementById("phase").innerText = data.phase;
          document.getElementById("tokens_trained").innerText = data.tokens_trained;
          document.getElementById("loss").innerText = data.loss;
          document.getElementById("dtype").innerText = data.dtype;
          document.getElementById("last_update").innerText = data.last_update;
          appendToDebugLog("Success fetching stats");
        })
        .catch(err => {
          const errMsg = document.createElement("div");
          //appendToDebugLog("Failed fetching stats.")
          document.getElementById("messages").appendChild(errMsg);
          appendToDebugLog(err);
        });
      }
      getStats();
      //setInterval(getStats, 5000);
      appendToDebugLog("Updating stats - interval {5s}");
      </script>


<script type="module">
  import { fetchEventSource } from 'https://cdn.jsdelivr.net/npm/@microsoft/fetch-event-source@2.0.1/+esm';

  const conversation_id = Date.now();

  const inputBox = document.getElementById("user-input");
  const sendBtn = document.getElementById("sendBtn")
  const messages = document.getElementById("messages");

  document.getElementById("sendBtn").addEventListener("click", () => {
    const message = inputBox.value.trim();
    if (!message) return;
    inputBox.value = "";

    // User message
    const userMsg = document.createElement("div");
    userMsg.className = "message user";
    userMsg.innerHTML = `<div class="message-text">You: ${message}</div>`;
    messages.appendChild(userMsg);

    // Bot message
    const botMsg = document.createElement("div");
    botMsg.className = "message bot";
    const botText = document.createElement("div");
    botText.className = "message-text";
    botText.innerHTML = `Bot: <span class="bot-stream"></span>`;
    botMsg.appendChild(botText);
    messages.appendChild(botMsg);

    const streamTarget = botMsg.querySelector(".bot-stream");
    // Payload
    const payload = {
      request_type: "chat",
      prompt: message,
      conversation_id: conversation_id,
      request_ip: "127.0.0.1"
    };

    const messagesContainer = document.getElementById("messages");
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    fetchEventSource("https://api.hipowerpc.com/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      onmessage(msg) {
        streamTarget.innerText += msg.data;
        const messagesContainer = document.getElementById("messages");
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      },
      onerror(err) {
        console.error("Streaming error:", err);
        if (!streamTarget.innerText.includes("API service coming soon!")) {
          streamTarget.innerText += "API service coming soon!";
          appendToDebugLog("Bot stream error: " + err);
        }
      }
    });
  });

</script>
<script src="codeflow.js"></script>
</body>
</html>